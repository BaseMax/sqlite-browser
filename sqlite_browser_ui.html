<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL.js with Worker</title>
    <link type="text/css" href="bootstrap.min.css" rel="stylesheet">
    <link type="text/css" href="codemirror.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h2>SQL Editor</h2>
                <div class="mb-3">
                    <textarea id="commands" class="form-control" rows="10"></textarea>
                </div>
                <button id="execute" class="btn btn-primary">Execute SQL</button>
                <button id="savedb" class="btn btn-success">Save Database</button>
                <input type="file" id="dbfile" class="form-control mt-3" accept=".db">
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div id="output"></div>
                <div id="error" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="codemirror.min.js"></script>
    <script type="text/javascript" src="sql.min.js"></script>
    <script type="text/javascript">
        var execBtn = document.getElementById("execute");
        var outputElm = document.getElementById('output');
        var errorElm = document.getElementById('error');
        var commandsElm = document.getElementById('commands');
        var dbFileElm = document.getElementById('dbfile');
        var savedbElm = document.getElementById('savedb');

        var worker = new Worker("worker.sql-wasm.js");
        worker.onerror = error;

        worker.postMessage({ action: 'open' });

        function print(text) {
            outputElm.innerHTML = text.replace(/\n/g, '<br>');
        }

        function error(e) {
            console.log(e);
            errorElm.style.display = 'block';
            errorElm.textContent = e.message;
        }

        function noerror() {
            errorElm.style.display = 'none';
        }

        function execute(commands) {
            tic();
            worker.onmessage = function (event) {
                var results = event.data.results;
                toc("Executing SQL");
                if (!results) {
                    error({ message: event.data.error });
                    return;
                }

                tic();
                outputElm.innerHTML = "";
                for (var i = 0; i < results.length; i++) {
                    outputElm.appendChild(tableCreate(results[i].columns, results[i].values));
                }
                toc("Displaying results");
            };
            worker.postMessage({ action: 'exec', sql: commands });
            outputElm.textContent = "Fetching results...";
        }

        var tableCreate = function () {
            function valconcat(vals, tagName) {
                if (vals.length === 0) return '';
                var open = '<' + tagName + '>', close = '</' + tagName + '>';
                return open + vals.join(close + open) + close;
            }
            return function (columns, values) {
                var tbl = document.createElement('table');
                var html = '<thead>' + valconcat(columns, 'th') + '</thead>';
                var rows = values.map(function (v) { return valconcat(v, 'td'); });
                html += '<tbody>' + valconcat(rows, 'tr') + '</tbody>';
                tbl.innerHTML = html;
                return tbl;
            };
        }();

        function execEditorContents() {
            noerror()
            execute(editor.getValue() + ';');
        }
        execBtn.addEventListener("click", execEditorContents, true);

        var tictime;
        if (!window.performance || !performance.now) { window.performance = { now: Date.now } }
        function tic() { tictime = performance.now() }
        function toc(msg) {
            var dt = performance.now() - tictime;
            console.log((msg || 'toc') + ": " + dt + "ms");
        }

        var editor = CodeMirror.fromTextArea(commandsElm, {
            mode: 'text/x-mysql',
            viewportMargin: Infinity,
            indentWithTabs: true,
            smartIndent: true,
            lineNumbers: true,
            matchBrackets: true,
            autofocus: true,
            extraKeys: {
                "Ctrl-Enter": execEditorContents,
                "Ctrl-S": savedb,
            }
        });

        dbFileElm.onchange = function () {
            var f = dbFileElm.files[0];
            var r = new FileReader();
            r.onload = function () {
                worker.onmessage = function () {
                    toc("Loading database from file");
                    editor.setValue("SELECT `name`, `sql`\n  FROM `sqlite_master`\n  WHERE type='table';");
                    execEditorContents();
                };
                tic();
                try {
                    worker.postMessage({ action: 'open', buffer: r.result }, [r.result]);
                } catch (exception) {
                    worker.postMessage({ action: 'open', buffer: r.result });
                }
            };
            r.readAsArrayBuffer(f);
        };

        function savedb() {
            worker.onmessage = function (event) {
                toc("Exporting the database");
                var arraybuff = event.data.buffer;
                var blob = new Blob([arraybuff]);
                var a = document.createElement("a");
                document.body.appendChild(a);
                a.href = window.URL.createObjectURL(blob);
                a.download = "sql.db";
                a.onclick = function () {
                    setTimeout(function () {
                        window.URL.revokeObjectURL(a.href);
                    }, 1500);
                };
                a.click();
            };
            tic();
            worker.postMessage({ action: 'export' });
        }
        savedbElm.addEventListener("click", savedb, true);
    </script>
    <script src="popper.min.js"></script>
    <script src="bootstrap.min.js"></script>
</body>
</html>
